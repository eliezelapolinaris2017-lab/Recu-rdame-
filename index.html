<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Recordatorios WhatsApp</title>
<style>
  :root{--bg:#0f0f12;--fg:#fff;--muted:#a7a7b1;--card:#171821;--btn:#24263a;--outline:#2a2d40}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;background:#11121a;padding:12px 16px;border-bottom:1px solid var(--outline)}
  h1{margin:0;font-size:18px}
  .bar{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  select,input,button{background:var(--btn);color:var(--fg);border:1px solid var(--outline);border-radius:8px;padding:8px 10px}
  main{padding:16px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--outline);padding:10px;text-align:left;font-size:14px}
  .chip{display:inline-block;padding:2px 8px;border:1px solid var(--outline);border-radius:999px;font-size:12px;color:var(--muted)}
  .row-actions{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:8px 10px;border-radius:999px;border:1px solid var(--outline);cursor:pointer}
  .empty{color:var(--muted);padding:24px;text-align:center}
  .day-head{padding:14px 8px;font-weight:600;border-bottom:1px solid var(--outline);background:#11121a}
  footer{padding:16px;color:var(--muted);text-align:center;border-top:1px solid var(--outline)}
</style>
</head>
<body>
  <header>
    <h1>Recordatorios de Citas — WhatsApp</h1>
    <div class="bar">
      <label>Rango:
        <select id="range">
          <option value="1">Solo Hoy</option>
          <option value="2" selected>Hoy + Mañana</option>
          <option value="3">3 días</option>
          <option value="7">7 días</option>
          <option value="14">14 días</option>
        </select>
      </label>
      <input id="q" placeholder="Buscar por nombre, servicio o técnica">
      <button id="refresh">Actualizar</button>
      <!-- Botón masivo (opcional, requiere Cloud API configurada) -->
      <button id="sendTomorrow">Enviar a todos los de Mañana</button>
    </div>
  </header>

  <main>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Cliente</th>
          <th>Teléfono</th>
          <th>Servicio</th>
          <th>Técnica</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div id="empty" class="empty" style="display:none">No hay citas en el rango seleccionado.</div>
  </main>

  <footer>Funciona con tu Calendar sin cambiar tu formulario</footer>

<script>
  const $ = s => document.querySelector(s);
  let cache = [];

  $('#refresh').addEventListener('click', load);
  $('#range').addEventListener('change', load);
  $('#q').addEventListener('input', filter);

  // Enviar a todos los de mañana (usa Cloud API si la configuraste)
  $('#sendTomorrow').addEventListener('click', () => {
    if (!confirm('¿Enviar recordatorio a TODOS los de mañana?')) return;
    google.script.run.withSuccessHandler(res => {
      alert('Envíos procesados: ' + JSON.stringify(res));
    }).sendAllTomorrow();
  });

  function load() {
    const days = $('#range').value;
    google.script.run.withSuccessHandler(data => { cache = data || []; render(cache); })
      .getUpcoming(days);
  }

  function filter() {
    const term = ($('#q').value || '').toLowerCase();
    render(cache.filter(r =>
      [r.nombre, r.servicio, r.tecnica].filter(Boolean).some(v => v.toLowerCase().includes(term))
    ));
  }

  function render(list) {
    const tbody = $('#rows'); tbody.innerHTML = '';
    if (!list.length) { document.getElementById('empty').style.display = 'block'; return; }
    document.getElementById('empty').style.display = 'none';

    // Agrupar por día (YYYY-MM-DD)
    const byDay = {};
    for (const it of list) {
      const d = new Date(it.startISO);
      const key = d.toISOString().slice(0,10);
      (byDay[key] ||= []).push(it);
    }

    const now = new Date(); normalizeMidnight(now);
    const tomorrow = new Date(now); tomorrow.setDate(now.getDate()+1); normalizeMidnight(tomorrow);

    for (const key of Object.keys(byDay).sort()) {
      const [y,m,day] = key.split('-').map(n=>parseInt(n,10));
      const dt = new Date(y, m-1, day); normalizeMidnight(dt);

      let label = byDay[key][0].fechaStr; // texto largo por defecto
      if (sameDay(dt, now)) label = 'Hoy';
      else if (sameDay(dt, tomorrow)) label = 'Mañana';

      const head = document.createElement('tr');
      head.innerHTML = `<td class="day-head" colspan="7">${label} — ${byDay[key].length} cita(s)</td>`;
      tbody.appendChild(head);

      for (const it of byDay[key]) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.fechaStr}</td>
          <td>${it.horaStr}</td>
          <td>${esc(it.nombre)}</td>
          <td>${fmtPhone(it.telefono)}</td>
          <td>${esc(it.servicio)}</td>
          <td><span class="chip">${esc(it.tecnica)}</span></td>
          <td class="row-actions">
            ${it.waLink ? `<a class="pill" href="${it.waLink}" target="_blank" rel="noopener">Enviar WhatsApp</a>` : ''}
            <button class="pill" onclick='copyMsg(${JSON.stringify(it.mensaje)})'>Copiar mensaje</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }
  }

  function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function fmtPhone(s){if(!s)return'';return String(s).replace(/\D+/g,'').replace(/^1?(\d{3})(\d{3})(\d{4})$/,'($1) $2-$3')}
  async function copyMsg(t){try{await navigator.clipboard.writeText(t);alert('Mensaje copiado')}catch(e){prompt('Copia el mensaje:',t)}}
  function normalizeMidnight(d){d.setHours(0,0,0,0)}
  function sameDay(a,b){return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate()}

  // Carga inicial: HOY + MAÑANA
  load();
</script>
</body>
</html>
