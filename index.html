<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Salon Pro — Recordatorios</title>
<style id="theme">
:root{
--bg:#0f0f12; --fg:#ffffff; --muted:#a7a7b1;
--topbar:#11121a; --card:#171821; --btn:#24263a; --outline:#2a2d40; --accent:#6ee7b7;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg)}
a{color:var(--accent);text-decoration:none}
header.topbar{position:sticky;top:0;background:var(--topbar);border-bottom:1px solid var(--outline);z-index:10}
.topwrap{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:28px;width:auto;border-radius:6px}
.brand .title{font-weight:600}
nav.menu{display:flex;gap:8px}
nav.menu button{background:var(--btn);color:var(--fg);border:1px solid var(--outline);border-radius:8px;padding:8px 10px;cursor:pointer}
main{padding:16px}
.card{background:var(--card);border:1px solid var(--outline);border-radius:12px;padding:16px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--outline);padding:10px;text-align:left;font-size:14px}
.chip{display:inline-block;padding:2px 8px;border:1px solid var(--outline);border-radius:999px;font-size:12px;color:var(--muted)}
.row-actions{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:8px 10px;border-radius:999px;border:1px solid var(--outline);background:var(--btn);cursor:pointer}
.bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.bar select,.bar input,.bar button{background:var(--btn);color:var(--fg);border:1px solid var(--outline);border-radius:8px;padding:8px 10px}
.day-head{padding:12px;border-radius:8px;margin-top:14px;margin-bottom:6px;background:#11121a;border:1px solid var(--outline);font-weight:600}
.empty{color:var(--muted);padding:24px;text-align:center}
footer{padding:16px;color:var(--muted);text-align:center;border-top:1px solid var(--outline)}
/* Login */
.login{max-width:380px;margin:6vh auto}
.login input, .cfg input, .cfg textarea{width:100%}
.grid{display:grid;gap:10px}
.grid.cols2{grid-template-columns:1fr 1fr}
.cfg img{max-height:64px;border:1px solid var(--outline);border-radius:8px;padding:4px;background:#0b0b0f}
</style>
</head>
<body>

<header class="topbar">
<div class="topwrap">
<div class="brand">
<img id="logo" alt="" style="display:none">
<div class="title" id="brandTitle">Salon Pro — Recordatorios</div>
</div>
<nav class="menu">
<button id="btnView" class="pill">Citas</button>
<button id="btnCfg" class="pill">Configuración</button>
<button id="btnLogout" class="pill">Salir</button>
</nav>
</div>
</header>

<main>
<!-- LOGIN -->
<section id="secLogin" class="login card" style="display:none">
<h2>Acceso</h2>
<div class="grid">
<input id="inUser" placeholder="Usuario" autocomplete="username">
<input id="inPass" placeholder="Contraseña" type="password" autocomplete="current-password">
<button class="pill" id="doLogin">Entrar</button>
<div id="loginMsg" style="color:#ff8080"></div>
</div>
<p class="empty">Define usuarios en Propiedades del Script → <b>APP_USERS</b> (JSON).</p>
</section>

<!-- CITAS -->
<section id="secCitas" class="card" style="display:none">
<div class="bar">
<label>Rango:
<select id="range">
<option value="1">Solo Hoy</option>
<option value="2" selected>Hoy + Mañana</option>
<option value="3">3 días</option>
<option value="7">7 días</option>
<option value="14">14 días</option>
</select>
</label>
<input id="q" placeholder="Buscar por nombre, servicio o técnica">
<select id="techFilter">
<option value="">Todas las técnicas</option>
</select>
<button id="refresh">Actualizar</button>
<button id="sendTomorrow">Enviar a todos (Mañana)</button>
</div>

<div id="list"></div>
<div id="empty" class="empty" style="display:none">No hay citas en el rango.</div>
</section>

<!-- CONFIG -->
<section id="secCfg" class="card cfg" style="display:none">
<h2>Configuración</h2>
<div class="grid">
<label>Nombre del negocio
<input id="cfg_business">
</label>
<label>Calendar ID
<input id="cfg_calid">
</label>
</div>

<h3>Logo</h3>
<div class="grid">
<label>Subir archivo (PNG/JPG)
<input type="file" id="cfg_logoFile" accept="image/*">
</label>
<img id="previewLogo" style="display:none" alt="Logo">
</div>

<h3>Tema</h3>
<div class="grid cols2">
<label>Fondo <input type="color" id="c_bg"></label>
<label>Texto <input type="color" id="c_fg"></label>
<label>Muted <input type="color" id="c_muted"></label>
<label>Topbar <input type="color" id="c_topbar"></label>
<label>Card <input type="color" id="c_card"></label>
<label>Botón <input type="color" id="c_btn"></label>
<label>Outline <input type="color" id="c_outline"></label>
<label>Accent <input type="color" id="c_accent"></label>
</div>

<h3>Plantilla WhatsApp</h3>
<p class="empty">Variables: <b>{{nombre}}</b>, <b>{{fecha}}</b>, <b>{{hora}}</b>, <b>{{servicio}}</b>, <b>{{servicioLine}}</b></p>
<textarea id="cfg_template" rows="6"></textarea>

<div class="bar" style="margin-top:12px">
<button id="saveCfg" class="pill">Aplicar cambios</button>
<span id="cfgMsg" class="empty"></span>
</div>
</section>
</main>

<footer id="foot">© <span id="year"></span> <span id="footBiz">Cynthia’s Salón</span> · Hecho con ❤️</footer>

<script>
// ===== Estado =====
let SESSION = { logged: false };
let CONFIG = null;
let CACHE = [];
let UPLOADED_LOGO_URL = '';

// ===== Util =====
const $ = s => document.querySelector(s);
function midnight(d){ d.setHours(0,0,0,0) }
function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate() }
function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function fmtPhone(s){if(!s)return'';return String(s).replace(/\D+/g,'').replace(/^1?(\d{3})(\d{3})(\d{4})$/,'($1) $2-$3')}
function rgb2hex(x){ if(!x) return '#000000'; if(x.startsWith('#')) return x; const m = x.match(/(\d+),\s*(\d+),\s*(\d+)/); if(!m) return '#000000'; const toH=v=>('0'+(Number(v).toString(16))).slice(-2); return '#'+toH(m[1])+toH(m[2])+toH(m[3]) }

// ===== Nav / Hooks =====
document.getElementById('year').textContent = new Date().getFullYear();
$('#btnView').onclick = () => show('citas');
$('#btnCfg').onclick = () => { openCfg(); show('cfg'); };
$('#btnLogout').onclick = () => logout();

$('#doLogin').onclick = login;
$('#refresh').onclick = load;
$('#range').onchange = load;
$('#q').oninput = filter;
$('#techFilter').onchange = filter;
$('#sendTomorrow').onclick = sendAllTomorrow;
$('#saveCfg').onclick = saveConfig;

// Logo upload → lee base64, envia al backend
document.getElementById('cfg_logoFile').addEventListener('change', e=>{
const file = e.target.files[0];
if (!file) return;
const fr = new FileReader();
fr.onload = function(evt){
const dataURL = evt.target.result; // "data:image/png;base64,AAAA..."
const [head, b64data] = dataURL.split(',');
const mime = (head.match(/^data:(.*?);base64$/)||[])[1] || 'image/png';
google.script.run.withSuccessHandler(url=>{
UPLOADED_LOGO_URL = url;
const img = document.getElementById('previewLogo');
img.src = url; img.style.display='block';
}).uploadLogoFromBase64(b64data, mime, file.name);
};
fr.readAsDataURL(file);
});

// ===== Boot =====
boot();

function boot(){
google.script.run.withSuccessHandler(cfg => {
CONFIG = cfg;
applyTheme(cfg.theme);
paintBrand();
show('login');
}).getConfig();
}

function applyTheme(t){
const css = `
:root{
--bg:${t.bg}; --fg:${t.fg}; --muted:${t.muted};
--topbar:${t.topbar}; --card:${t.card}; --btn:${t.btn};
--outline:${t.outline}; --accent:${t.accent};
}`;
const themeEl = document.getElementById('theme');
const rest = themeEl.textContent.split('/*CUT*/')[1] || '';
themeEl.textContent = css + '/*CUT*/' + rest;
}

function paintBrand(){
$('#brandTitle').textContent = (CONFIG?.businessName || 'Salon Pro — Recordatorios');
$('#footBiz').textContent = CONFIG?.businessName || 'Cynthia’s Salón';
const logo = $('#logo');
if (CONFIG?.logoUrl){
logo.src = CONFIG.logoUrl; logo.style.display='block';
} else {
logo.style.display='none';
}
}

function show(what){
$('#secLogin').style.display = (what==='login') ? 'block':'none';
$('#secCitas').style.display = (what==='citas') ? 'block':'none';
$('#secCfg').style.display = (what==='cfg') ? 'block':'none';
}

// ===== Login =====
function login(){
const u = $('#inUser').value.trim();
const p = $('#inPass').value;
$('#loginMsg').textContent = '';
google.script.run.withSuccessHandler(res => {
if(res && res.ok){
SESSION = { logged:true, user:res.user, role:res.role, name:res.name };
// Solo admin ve Configuración
$('#btnCfg').style.display = (res.role === 'admin') ? 'inline-block' : 'none';
show('citas');
load();
} else {
$('#loginMsg').textContent = 'Usuario o contraseña inválidos.';
}
}).validateLogin(u,p);
}

function logout(){
SESSION = { logged:false };
$('#inPass').value='';
show('login');
}

// ===== Citas =====
function load(){
const days = $('#range').value;
google.script.run.withSuccessHandler(res => {
const data = res || { items: [], techniques: [] };
CACHE = data.items || [];

// Poblar filtro de técnicas
const sel = $('#techFilter');
const prev = sel.value;
sel.innerHTML = `<option value="">Todas las técnicas</option>` +
(data.techniques || []).map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');
if (Array.from(sel.options).some(o => o.value === prev)) sel.value = prev;

render(CACHE);
}).getUpcomingWithTechs(days);
}

function filter(){
const term = ($('#q').value || '').toLowerCase();
const tech = $('#techFilter').value;
const list = CACHE.filter(r => {
const passText = [r.nombre, r.servicio, r.tecnica].filter(Boolean)
.some(v => v.toLowerCase().includes(term));
const passTech = !tech || (r.tecnica === tech);
return passText && passTech;
});
render(list);
}

function render(list){
const mount = $('#list');
mount.innerHTML = '';
if(!list.length){ $('#empty').style.display='block'; return; }
$('#empty').style.display='none';

// Agrupar por día
const byDay = {};
for(const it of list){
const d = new Date(it.startISO);
const key = d.toISOString().slice(0,10);
(byDay[key] ||= []).push(it);
}

const now = new Date(); midnight(now);
const tom = new Date(now); tom.setDate(now.getDate()+1); midnight(tom);

for(const key of Object.keys(byDay).sort()){
const [y,m,d] = key.split('-').map(n=>parseInt(n,10));
const dt = new Date(y,m-1,d); midnight(dt);
let label = byDay[key][0].fechaStr;
if (sameDay(dt,now)) label = 'Hoy';
else if (sameDay(dt,tom)) label = 'Mañana';

const head = document.createElement('div');
head.className = 'day-head';
head.textContent = `${label} — ${byDay[key].length} cita(s)`;
mount.appendChild(head);

const table = document.createElement('table');
table.innerHTML = `
<thead>
<tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Teléfono</th><th>Servicio</th><th>Técnica</th><th>Acciones</th></tr>
</thead>
<tbody></tbody>`;
mount.appendChild(table);

const tb = table.querySelector('tbody');
for(const it of byDay[key]){
const tr = document.createElement('tr');
tr.innerHTML = `
<td>${it.fechaStr}</td>
<td>${it.horaStr}</td>
<td>${esc(it.nombre)}</td>
<td>${fmtPhone(it.telefono)}</td>
<td>${esc(it.servicio)}</td>
<td><span class="chip">${esc(it.tecnica)}</span></td>
<td class="row-actions">
${it.waLink ? `<a class="pill" href="${it.waLink}" target="_blank" rel="noopener">WhatsApp</a>` : ''}
<button class="pill" onclick='copyMsg(${JSON.stringify(it.mensaje)})'>Copiar</button>
</td>`;
tb.appendChild(tr);
}
}
}

async function copyMsg(t){
try{ await navigator.clipboard.writeText(t); alert('Mensaje copiado'); }
catch(e){ prompt('Copia el mensaje:', t); }
}

// ===== Config =====
function openCfg(){
$('#cfg_business').value = CONFIG.businessName || '';
$('#cfg_calid').value = CONFIG.calendarId || '';
$('#cfg_template').value = CONFIG.waTemplate || '';
// Colores
const t = CONFIG.theme || {};
$('#c_bg').value = rgb2hex(t.bg || '#0f0f12');
$('#c_fg').value = rgb2hex(t.fg || '#ffffff');
$('#c_muted').value = rgb2hex(t.muted || '#a7a7b1');
$('#c_topbar').value = rgb2hex(t.topbar || '#11121a');
$('#c_card').value = rgb2hex(t.card || '#171821');
$('#c_btn').value = rgb2hex(t.btn || '#24263a');
$('#c_outline').value = rgb2hex(t.outline || '#2a2d40');
$('#c_accent').value = rgb2hex(t.accent || '#6ee7b7');
// Logo actual
if (CONFIG.logoUrl) {
$('#previewLogo').src = CONFIG.logoUrl;
$('#previewLogo').style.display = 'block';
} else {
$('#previewLogo').style.display = 'none';
}
}

function saveConfig(){
const cfg = {
businessName: $('#cfg_business').value.trim(),
calendarId: $('#cfg_calid').value.trim(),
logoUrl: UPLOADED_LOGO_URL || (CONFIG.logoUrl || ''),
waTemplate: $('#cfg_template').value,
defaultRangeDays: Number($('#range').value) || 2,
theme:{
bg:$('#c_bg').value, fg:$('#c_fg').value, muted:$('#c_muted').value,
topbar:$('#c_topbar').value, card:$('#c_card').value, btn:$('#c_btn').value,
outline:$('#c_outline').value, accent:$('#c_accent').value
}
};
google.script.run.withSuccessHandler(newCfg=>{
CONFIG = newCfg;
applyTheme(CONFIG.theme);
paintBrand();
$('#cfgMsg').textContent='Guardado ✓';
setTimeout(()=>$('#cfgMsg').textContent='',2000);
}).withFailureHandler(err=>{
$('#cfgMsg').textContent = (err && err.message) ? err.message : 'Error al guardar';
}).saveConfigAdmin(SESSION.user, cfg);
}

// ===== Envío masivo (opcional, requiere Cloud API configurada) =====
function sendAllTomorrow(){
if (!confirm('¿Enviar recordatorio a TODOS los de mañana?')) return;
google.script.run.withSuccessHandler(res=>{
alert('Procesados: ' + JSON.stringify(res || []));
}).withFailureHandler(err=>{
alert('Error: ' + (err && err.message ? err.message : err));
}).sendAllTomorrow();
}

// Arranque
show('login');
</script>
</body>
</html>
