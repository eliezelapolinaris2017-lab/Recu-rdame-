<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Salon Pro — Recordatorios</title>
<style id="theme">
  :root{
    --bg:#0f0f12; --fg:#ffffff; --muted:#a7a7b1;
    --topbar:#11121a; --card:#171821; --btn:#24263a; --outline:#2a2d40; --accent:#6ee7b7;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg)}
  a{color:var(--accent);text-decoration:none}
  header.topbar{position:sticky;top:0;background:var(--topbar);border-bottom:1px solid var(--outline);z-index:10}
  .topwrap{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:28px;width:auto;border-radius:6px}
  .brand .title{font-weight:600}
  nav.menu{display:flex;gap:8px}
  nav.menu button{background:var(--btn);color:var(--fg);border:1px solid var(--outline);border-radius:8px;padding:8px 10px;cursor:pointer}
  main{padding:16px}
  .card{background:var(--card);border:1px solid var(--outline);border-radius:12px;padding:16px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--outline);padding:10px;text-align:left;font-size:14px}
  .chip{display:inline-block;padding:2px 8px;border:1px solid var(--outline);border-radius:999px;font-size:12px;color:var(--muted)}
  .row-actions{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:8px 10px;border-radius:999px;border:1px solid var(--outline);background:var(--btn);cursor:pointer}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .bar select,.bar input,.bar button{background:var(--btn);color:var(--fg);border:1px solid var(--outline);border-radius:8px;padding:8px 10px}
  .day-head{padding:12px;border-radius:8px;margin-top:14px;margin-bottom:6px;background:#11121a;border:1px solid var(--outline);font-weight:600}
  .empty{color:var(--muted);padding:24px;text-align:center}
  footer{padding:16px;color:var(--muted);text-align:center;border-top:1px solid var(--outline)}
  /* Login */
  .login{max-width:380px;margin:6vh auto}
  .login input, .cfg input, .cfg textarea{width:100%}
  .grid{display:grid;gap:10px}
  .grid.cols2{grid-template-columns:1fr 1fr}
</style>
</head>
<body>

<header class="topbar">
  <div class="topwrap">
    <div class="brand">
      <img id="logo" alt="" style="display:none">
      <div class="title" id="brandTitle">Salon Pro — Recordatorios</div>
    </div>
    <nav class="menu">
      <button id="btnView" class="pill">Citas</button>
      <button id="btnCfg" class="pill">Configuración</button>
      <button id="btnLogout" class="pill">Salir</button>
    </nav>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <section id="secLogin" class="login card" style="display:none">
    <h2>Acceso</h2>
    <div class="grid">
      <input id="inUser" placeholder="Usuario">
      <input id="inPass" placeholder="Contraseña" type="password">
      <button class="pill" id="doLogin">Entrar</button>
      <div id="loginMsg" style="color:#ff8080"></div>
    </div>
    <p class="empty">Configura ADMIN_USER y ADMIN_PASS en Propiedades del Script.</p>
  </section>

  <!-- CITAS -->
  <section id="secCitas" class="card" style="display:none">
    <div class="bar">
      <label>Rango:
        <select id="range">
          <option value="1">Solo Hoy</option>
          <option value="2" selected>Hoy + Mañana</option>
          <option value="3">3 días</option>
          <option value="7">7 días</option>
          <option value="14">14 días</option>
        </select>
      </label>
      <input id="q" placeholder="Buscar por nombre, servicio o técnica">
      <button id="refresh">Actualizar</button>
      <button id="sendTomorrow">Enviar a todos (Mañana)</button>
    </div>

    <div id="list"></div>
    <div id="empty" class="empty" style="display:none">No hay citas en el rango.</div>
  </section>

  <!-- CONFIG -->
  <section id="secCfg" class="card cfg" style="display:none">
    <h2>Configuración</h2>
    <div class="grid">
      <label>Nombre del negocio
        <input id="cfg_business">
      </label>
      <label>Calendar ID
        <input id="cfg_calid">
      </label>
      <label>Logo (URL pública)
        <input id="cfg_logo">
      </label>
    </div>
    <h3>Tema</h3>
    <div class="grid cols2">
      <label>Fondo <input type="color" id="c_bg"></label>
      <label>Texto <input type="color" id="c_fg"></label>
      <label>Muted <input type="color" id="c_muted"></label>
      <label>Topbar <input type="color" id="c_topbar"></label>
      <label>Card <input type="color" id="c_card"></label>
      <label>Botón <input type="color" id="c_btn"></label>
      <label>Outline <input type="color" id="c_outline"></label>
      <label>Accent <input type="color" id="c_accent"></label>
    </div>

    <h3>Plantilla WhatsApp</h3>
    <p class="empty">Soporta variables: <b>{{nombre}}</b>, <b>{{fecha}}</b>, <b>{{hora}}</b>, <b>{{servicio}}</b>, <b>{{servicioLine}}</b></p>
    <textarea id="cfg_template" rows="6" style="width:100%"></textarea>

    <div class="bar" style="margin-top:12px">
      <button id="saveCfg" class="pill">Guardar configuración</button>
      <span id="cfgMsg" class="empty"></span>
    </div>
  </section>
</main>

<footer id="foot">© <span id="year"></span> <span id="footBiz">Cynthia’s Salón</span> · Hecho con ❤️</footer>

<script>
  // ===== Estado =====
  let SESSION = { logged: false };
  let CONFIG  = null;
  let CACHE   = [];

  // ===== Inicio =====
  document.getElementById('year').textContent = new Date().getFullYear();

  // Nav
  const $ = s => document.querySelector(s);
  $('#btnView').onclick = () => show('citas');
  $('#btnCfg').onclick  = () => show('cfg');
  $('#btnLogout').onclick = () => logout();

  $('#doLogin').onclick = login;
  $('#refresh').onclick = load;
  $('#range').onchange  = load;
  $('#q').oninput       = filter;
  $('#sendTomorrow').onclick = sendAllTomorrow;
  $('#saveCfg').onclick = saveConfig;

  // Carga inicial
  boot();

  function boot(){
    // Arranca pidiendo config para pintar tema y marca; luego muestra login
    google.script.run.withSuccessHandler(cfg => {
      CONFIG = cfg;
      applyTheme(cfg.theme);
      paintBrand();
      show('login');
    }).getConfig();
  }

  function show(what){
    $('#secLogin').style.display = what==='login' ? 'block':'none';
    $('#secCitas').style.display = what==='citas' ? 'block':'none';
    $('#secCfg').style.display   = what==='cfg'   ? 'block':'none';
  }

  function login(){
    const u = $('#inUser').value.trim();
    const p = $('#inPass').value;
    $('#loginMsg').textContent = '';
    google.script.run.withSuccessHandler(ok => {
      if(ok){
        SESSION.logged = true;
        show('citas');
        load();
      }else{
        $('#loginMsg').textContent = 'Usuario o contraseña inválidos.';
      }
    }).validateLogin(u,p);
  }

  function logout(){
    SESSION.logged = false;
    $('#inPass').value = '';
    show('login');
  }

  // ===== Citas =====
  function load(){
    const days = $('#range').value;
    google.script.run.withSuccessHandler(data => {
      CACHE = data || [];
      render(CACHE);
    }).getUpcoming(days);
  }

  function filter(){
    const term = ($('#q').value || '').toLowerCase();
    render(CACHE.filter(r =>
      [r.nombre, r.servicio, r.tecnica].filter(Boolean).some(v => v.toLowerCase().includes(term))
    ));
  }

  function render(list){
    const mount = $('#list');
    mount.innerHTML = '';
    if(!list.length){ $('#empty').style.display='block'; return; }
    $('#empty').style.display='none';

    // Agrupa por día
    const byDay = {};
    for(const it of list){
      const d = new Date(it.startISO);
      const key = d.toISOString().slice(0,10);
      (byDay[key] ||= []).push(it);
    }

    const now = new Date(); midnight(now);
    const tom = new Date(now); tom.setDate(now.getDate()+1); midnight(tom);

    for(const key of Object.keys(byDay).sort()){
      const [y,m,d] = key.split('-').map(n=>parseInt(n,10));
      const dt = new Date(y,m-1,d); midnight(dt);
      let label = byDay[key][0].fechaStr;
      if(sameDay(dt,now)) label = 'Hoy';
      else if(sameDay(dt,tom)) label = 'Mañana';

      const head = document.createElement('div');
      head.className = 'day-head';
      head.textContent = `${label} — ${byDay[key].length} cita(s)`;
      mount.appendChild(head);

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Teléfono</th><th>Servicio</th><th>Técnica</th><th>Acciones</th></tr>
        </thead>
        <tbody></tbody>`;
      mount.appendChild(table);

      const tb = table.querySelector('tbody');
      for(const it of byDay[key]){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.fechaStr}</td>
          <td>${it.horaStr}</td>
          <td>${esc(it.nombre)}</td>
          <td>${fmtPhone(it.telefono)}</td>
          <td>${esc(it.servicio)}</td>
          <td><span class="chip">${esc(it.tecnica)}</span></td>
          <td class="row-actions">
            ${it.waLink ? `<a class="pill" href="${it.waLink}" target="_blank" rel="noopener">WhatsApp</a>` : ''}
            <button class="pill" onclick='copyMsg(${JSON.stringify(it.mensaje)})'>Copiar</button>
          </td>`;
        tb.appendChild(tr);
      }
    }
  }

  // ===== Config =====
  function paintBrand(){
    $('#brandTitle').textContent = (CONFIG?.businessName || 'Salon Pro — Recordatorios');
    $('#footBiz').textContent = CONFIG?.businessName || 'Cynthia’s Salón';
    const logo = $('#logo');
    if(CONFIG?.logoUrl){
      logo.src = CONFIG.logoUrl; logo.style.display='block';
    }else{
      logo.style.display='none';
    }
  }

  function openCfg(){
    $('#cfg_business').value = CONFIG.businessName || '';
    $('#cfg_calid').value    = CONFIG.calendarId || '';
    $('#cfg_logo').value     = CONFIG.logoUrl || '';
    $('#cfg_template').value = CONFIG.waTemplate || '';
    // Colores
    const t = CONFIG.theme || {};
    $('#c_bg').value = rgb2hex(t.bg || '#0f0f12');
    $('#c_fg').value = rgb2hex(t.fg || '#ffffff');
    $('#c_muted').value = rgb2hex(t.muted || '#a7a7b1');
    $('#c_topbar').value = rgb2hex(t.topbar || '#11121a');
    $('#c_card').value = rgb2hex(t.card || '#171821');
    $('#c_btn').value = rgb2hex(t.btn || '#24263a');
    $('#c_outline').value = rgb2hex(t.outline || '#2a2d40');
    $('#c_accent').value = rgb2hex(t.accent || '#6ee7b7');
  }

  $('#btnCfg').addEventListener('click', () => {
    openCfg();
  });

  function saveConfig(){
    const cfg = {
      businessName: $('#cfg_business').value.trim(),
      calendarId: $('#cfg_calid').value.trim(),
      logoUrl: $('#cfg_logo').value.trim(),
      waTemplate: $('#cfg_template').value,
      defaultRangeDays: Number($('#range').value) || 2,
      theme: {
        bg: $('#c_bg').value, fg: $('#c_fg').value, muted: $('#c_muted').value,
        topbar: $('#c_topbar').value, card: $('#c_card').value, btn: $('#c_btn').value,
        outline: $('#c_outline').value, accent: $('#c_accent').value
      }
    };
    google.script.run.withSuccessHandler(newCfg => {
      CONFIG = newCfg;
      applyTheme(CONFIG.theme);
      paintBrand();
      $('#cfgMsg').textContent = 'Guardado ✓';
      setTimeout(()=> $('#cfgMsg').textContent='', 2000);
    }).saveConfig(cfg);
  }

  function applyTheme(t){
    const css = `
      :root{
        --bg:${t.bg}; --fg:${t.fg}; --muted:${t.muted};
        --topbar:${t.topbar}; --card:${t.card}; --btn:${t.btn};
        --outline:${t.outline}; --accent:${t.accent};
      }`;
    document.getElementById('theme').textContent = css + document.getElementById('theme').textContent.split('}/*CUT*/')[1] || '';
  }

  // ===== Utils =====
  function midnight(d){ d.setHours(0,0,0,0); }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function fmtPhone(s){if(!s)return'';return String(s).replace(/\D+/g,'').replace(/^1?(\d{3})(\d{3})(\d{4})$/,'($1) $2-$3')}
  async function copyMsg(t){try{await navigator.clipboard.writeText(t);alert('Mensaje copiado')}catch(e){prompt('Copia el mensaje:',t)}}
  function rgb2hex(x){ // por si viene como rgb(...)
    if(!x) return '#000000';
    if(x.startsWith('#')) return x;
    const m = x.match(/(\d+),\s*(\d+),\s*(\d+)/);
    if(!m) return '#000000';
    const toHex = v => ('0'+(Number(v).toString(16))).slice(-2);
    return '#'+toHex(m[1])+toHex(m[2])+toHex(m[3]);
  }

  // Mostrar login primero
  show('login');
</script>
</body>
</html>
